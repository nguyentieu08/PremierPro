<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NGUYỄN TIÊU - CHAT AI</title>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=JetBrains+Mono:wght@300;400;700&display=swap');

        :root {
            --primary: #00f2fe;
            --secondary: #7028e4;
            --accent: #ff0055;
            --bg: #020205;
            --font-mono: 'JetBrains Mono', monospace;
            --font-ui: 'Orbitron', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }

        body {
            height: 100vh;
            background-color: var(--bg);
            color: #fff;
            font-family: var(--font-mono);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }

        header {
            position: relative;
            z-index: 10;
            padding: 12px 15px;
            background: rgba(5, 5, 10, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 242, 254, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo {
            font-family: var(--font-ui);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 15px var(--primary);
            font-size: 1rem;
            letter-spacing: 1px;
        }

        .status-bar {
            display: flex;
            gap: 12px;
            font-size: 9px;
            font-family: var(--font-ui);
            color: rgba(255,255,255,0.7);
            font-weight: 700;
        }

        .status-bar span { color: var(--primary); }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            position: relative;
            z-index: 5;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scrollbar-width: none;
        }

        #chat-container::-webkit-scrollbar { display: none; }

        .message {
            max-width: 85%;
            padding: 12px 15px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.2s ease-out;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .message p { margin-bottom: 8px; }
        .message ul, .message ol { margin-left: 18px; margin-bottom: 8px; }
        .message strong { color: var(--primary); }
        .message code { background: rgba(255,255,255,0.15); padding: 2px 5px; border-radius: 4px; font-size: 0.9em; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .user-msg {
            align-self: flex-end;
            background: rgba(112, 40, 228, 0.3);
            border: 1px solid rgba(112, 40, 228, 0.6);
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            align-self: flex-start;
            background: rgba(0, 242, 254, 0.12);
            border: 1px solid rgba(0, 242, 254, 0.4);
            border-bottom-left-radius: 2px;
            color: #f0fbff;
        }

        .msg-info {
            font-size: 8px;
            text-transform: uppercase;
            margin-bottom: 6px;
            display: block;
            letter-spacing: 1px;
            font-family: var(--font-ui);
            font-weight: 700;
            opacity: 0.8;
        }

        .ai-msg .msg-info { color: var(--primary); }
        .user-msg .msg-info { color: var(--secondary); text-align: right; }

        /* Đẩy mạnh toàn bộ vùng nhập liệu lên cao hơn */
        .input-area {
            position: relative;
            z-index: 10;
            padding: 10px 15px 80px 15px; /* Tăng cực mạnh padding bottom để lên cao hẳn */
            background: linear-gradient(transparent, var(--bg) 20%);
        }

        .input-box {
            display: flex;
            background: rgba(25, 25, 40, 0.9);
            border: 1px solid rgba(0, 242, 254, 0.4);
            border-radius: 25px;
            padding: 5px 6px;
            backdrop-filter: blur(20px);
            max-width: 900px;
            margin: 0 auto;
            transition: all 0.3s;
        }

        .input-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 10px 15px;
            color: #fff;
            font-family: var(--font-mono);
            outline: none;
            font-size: 16px;
        }

        .send-btn {
            background: var(--primary);
            color: #000;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            font-family: var(--font-ui);
            font-weight: 900;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .send-btn:active { transform: scale(0.9); }

        .typing {
            font-size: 9px;
            color: var(--primary);
            margin-bottom: 8px;
            display: none;
            font-family: var(--font-ui);
            text-align: center;
            letter-spacing: 1px;
            text-shadow: 0 0 5px var(--primary);
        }
    </style>
</head>
<body onclick="App.initAudio()">

    <canvas id="bg-canvas"></canvas>

    <header>
        <div class="logo">NGUYỄN TIÊU - CHAT AI</div>
        <div class="status-bar">
            <div>PIN: <span id="battery-status">...</span></div>
            <div>TIME: <span id="current-time">00:00</span></div>
        </div>
    </header>

    <div id="chat-container"></div>

    <div class="input-area">
        <div id="typing" class="typing">NGUYỄN TIÊU AI ĐANG SUY NGHĨ...</div>
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Hỏi Nguyễn Tiêu AI..." autocomplete="off">
            <button class="send-btn" onclick="App.sendMessage()">></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nguyen-tieu-community';
        const apiKey = ""; 

        window.App = {
            audioCtx: null,
            user: null,

            async init() {
                this.setupVisuals();
                this.updateStatusBar();
                
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch(e) { console.error(e); }

                onAuthStateChanged(auth, (u) => {
                    this.user = u;
                    if(u) {
                        this.listenMessages();
                    }
                });

                document.getElementById('user-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });

                setInterval(() => this.updateTime(), 1000);
                this.updateBattery();
            },

            updateStatusBar() {
                this.updateTime();
                this.updateBattery();
            },

            updateTime() {
                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                              now.getMinutes().toString().padStart(2, '0');
                document.getElementById('current-time').innerText = timeStr;
            },

            async updateBattery() {
                try {
                    const battery = await navigator.getBattery();
                    const updateInfo = () => {
                        const level = Math.round(battery.level * 100) + "%";
                        document.getElementById('battery-status').innerText = level;
                    };
                    updateInfo();
                    battery.addEventListener('levelchange', updateInfo);
                } catch (e) {
                    document.getElementById('battery-status').innerText = "N/A";
                }
            },

            initAudio() {
                if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            },

            playSync(freq = 800, dur = 0.05) {
                if (!this.audioCtx) return;
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, this.audioCtx.currentTime);
                gain.gain.setValueAtTime(0.015, this.audioCtx.currentTime);
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.start();
                osc.stop(this.audioCtx.currentTime + dur);
            },

            listenMessages() {
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                onSnapshot(q, (snapshot) => {
                    const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    this.renderMessages(messages.slice(-40));
                }, (error) => {
                    console.error("Firestore error:", error);
                });
            },

            renderMessages(msgs) {
                const container = document.getElementById('chat-container');
                container.innerHTML = '';
                msgs.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `message ${m.role}-msg`;
                    const sender = m.role === 'ai' ? 'NGUYỄN TIÊU AI' : 'BẠN';
                    const content = m.role === 'ai' ? marked.parse(m.text) : m.text;
                    div.innerHTML = `<span class="msg-info">${sender}</span><div class="content-body">${content}</div>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
                this.playSync(1000, 0.08);
            },

            async sendMessage() {
                const input = document.getElementById('user-input');
                const text = input.value.trim();
                if (!text || !this.user) return;

                input.value = '';
                this.playSync(500, 0.05);

                const msgRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                
                try {
                    await addDoc(msgRef, {
                        text: text,
                        role: 'user',
                        uid: this.user.uid,
                        timestamp: Date.now()
                    });

                    document.getElementById('typing').style.display = 'block';

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            systemInstruction: { 
                                parts: [{ text: "Tên bạn là Nguyễn Tiêu AI. Bạn là một trợ lý AI thông minh bậc nhất, trả lời người dùng với phong cách chuyên nghiệp, chi tiết, trình bày rõ ràng (sử dụng danh sách, in đậm nếu cần) giống hệt Gemini. Luôn luôn bắt đầu hoặc kết thúc bằng việc khẳng định mình là Nguyễn Tiêu AI và sẵn sàng hỗ trợ bạn." }] 
                            }
                        })
                    });

                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Mất kết nối với lõi xử lý của Nguyễn Tiêu AI...";

                    await addDoc(msgRef, {
                        text: aiText,
                        role: 'ai',
                        uid: 'system',
                        timestamp: Date.now()
                    });

                } catch (e) { 
                    console.error(e); 
                    // Hiện lỗi nhẹ để người dùng biết
                    const container = document.getElementById('chat-container');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message ai-msg';
                    errorDiv.innerHTML = '<span class="msg-info">HỆ THỐNG</span>Lỗi kết nối API. Vui lòng thử lại.';
                    container.appendChild(errorDiv);
                }
                finally { document.getElementById('typing').style.display = 'none'; }
            },

            setupVisuals() {
                const canvas = document.getElementById('bg-canvas');
                const ctx = canvas.getContext('2d');
                let nodes = [];
                
                const resize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', resize);
                resize();

                for(let i=0; i<45; i++) {
                    nodes.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 0.3,
                        vy: (Math.random() - 0.5) * 0.3
                    });
                }

                const animate = () => {
                    ctx.fillStyle = "rgba(2, 2, 5, 0.25)";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    nodes.forEach((n, i) => {
                        n.x += n.vx; n.y += n.vy;
                        if(n.x<0 || n.x>canvas.width) n.vx*=-1;
                        if(n.y<0 || n.y>canvas.height) n.vy*=-1;
                        ctx.fillStyle = "rgba(0, 242, 254, 0.2)";
                        ctx.beginPath(); ctx.arc(n.x, n.y, 1, 0, Math.PI*2); ctx.fill();

                        for(let j=i+1; j<nodes.length; j++) {
                            let n2 = nodes[j];
                            let dist = Math.hypot(n.x - n2.x, n.y - n2.y);
                            if(dist < 130) {
                                ctx.strokeStyle = `rgba(0, 242, 254, ${0.08 * (1 - dist/130)})`;
                                ctx.lineWidth = 0.5;
                                ctx.beginPath(); ctx.moveTo(n.x, n.y); ctx.lineTo(n2.x, n2.y); ctx.stroke();
                            }
                        }
                    });
                    requestAnimationFrame(animate);
                };
                animate();
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
