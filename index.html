<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nguyễn Tiêu - Battle Royale (Vòng Bo)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87ceeb; touch-action: none; font-family: sans-serif; }
        #ui { position: fixed; top: 15px; left: 15px; color: white; text-shadow: 2px 2px 4px #000; pointer-events: none; z-index: 10; }
        #alive-count { color: #ffcc00; font-size: 24px; font-weight: bold; }
        #zone-info { color: #00e5ff; font-weight: bold; }
        
        .hp-box { width: 180px; height: 12px; background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 6px; margin-top: 8px; }
        #hp-fill { width: 100%; height: 100%; background: #ff0055; transition: 0.2s; }

        #joy-base { position: fixed; bottom: 40px; left: 40px; width: 110px; height: 110px; background: rgba(255,255,255,0.2); border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #00e5ff; border-radius: 50%; opacity: 0.8; }
        #fire-btn { position: fixed; bottom: 50px; right: 40px; width: 90px; height: 90px; background: rgba(255,0,0,0.6); border: 4px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; box-shadow: 0 0 15px rgba(255,0,0,0.5); }
        
        #crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #00ff00; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        #victory, #gameover { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        button { padding: 10px 30px; font-size: 18px; margin-top: 20px; background: #00e5ff; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="ui">
        ALIVE: <span id="alive-count">50</span>/50<br>
        <span id="zone-info">BO ĐANG THU: <span id="zone-size">500</span>m</span>
        <div class="hp-box"><div id="hp-fill"></div></div>
    </div>
    <div id="crosshair"></div>
    <div id="joy-base"><div id="joy-stick"></div></div>
    <div id="fire-btn">BẮN</div>

    <div id="victory"><h1 style="color:#00ff00">BOOYAH!<br>VICTORY</h1><button onclick="location.reload()">CHƠI LẠI</button></div>
    <div id="gameover"><h1 style="color:#ff0000">BẠN ĐÃ BỊ LOẠI!</h1><button onclick="location.reload()">THỬ LẠI</button></div>

    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Ánh sáng & Mặt đất
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshPhongMaterial({ color: 0x3b5d38 }));
        ground.rotation.x = -Math.PI/2; scene.add(ground);

        // Vòng Bo (The Zone)
        let zoneRadius = 500;
        const zoneGeo = new THREE.CylinderGeometry(zoneRadius, zoneRadius, 100, 64, 1, true);
        const zoneMat = new THREE.MeshBasicMaterial({ color: 0x00aaff, transparent: true, opacity: 0.3, side: THREE.DoubleSide });
        const zoneMesh = new THREE.Mesh(zoneGeo, zoneMat);
        zoneMesh.position.y = 50;
        scene.add(zoneMesh);

        // Cây & Nhà (Thế giới mở)
        for(let i=0; i<60; i++) {
            const x = Math.random()*800-400, z = Math.random()*800-400;
            if(i%2==0){
                const tree = new THREE.Group();
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 4), new THREE.MeshPhongMaterial({color: 0x4d2902}));
                const leaf = new THREE.Mesh(new THREE.ConeGeometry(3, 7, 8), new THREE.MeshPhongMaterial({color: 0x114411}));
                leaf.position.y = 4; tree.add(trunk); tree.add(leaf);
                tree.position.set(x, 2, z); scene.add(tree);
            } else {
                const house = new THREE.Mesh(new THREE.BoxGeometry(10, 8, 10), new THREE.MeshPhongMaterial({color: 0x777777}));
                house.position.set(x, 4, z); scene.add(house);
            }
        }

        // Người chơi
        const player = new THREE.Group();
        player.add(new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshPhongMaterial({color: 0x00e5ff})));
        player.position.set(0, 1, 0); scene.add(player);
        let playerHP = 100;

        // Bot (49 mạng)
        const enemies = [];
        for(let i=0; i<49; i++) {
            const bot = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2, 1.2), new THREE.MeshPhongMaterial({color: 0xff4444}));
            bot.position.set(Math.random()*600-300, 1, Math.random()*600-300);
            bot.userData = { hp: 100, lastShoot: 0 };
            scene.add(bot); enemies.push(bot);
        }

        // Điều khiển Mobile
        let joyId = null, lookId = null, moveX = 0, moveY = 0, yaw = 0, lastX = 0;
        const stick = document.getElementById('joy-stick');

        window.addEventListener('touchstart', (e) => {
            for(let t of e.changedTouches) {
                if(t.clientX < window.innerWidth/2) joyId = t.identifier;
                else if(t.target.id !== 'fire-btn') { lookId = t.identifier; lastX = t.clientX; }
            }
        });
        window.addEventListener('touchmove', (e) => {
            for(let t of e.touches) {
                if(t.identifier === joyId) {
                    let rect = document.getElementById('joy-base').getBoundingClientRect();
                    let dx = t.clientX-(rect.left+55), dy = t.clientY-(rect.top+55);
                    let d = Math.min(Math.hypot(dx,dy), 50), a = Math.atan2(dy,dx);
                    stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                    moveX = Math.cos(a)*(d/50); moveY = Math.sin(a)*(d/50);
                }
                if(t.identifier === lookId) { yaw -= (t.clientX - lastX)*0.007; lastX = t.clientX; }
            }
        });
        window.addEventListener('touchend', (e) => {
            for(let t of e.changedTouches) {
                if(t.identifier === joyId) { joyId = null; moveX = moveY = 0; stick.style.transform = ''; }
                if(t.identifier === lookId) lookId = null;
            }
        });

        // Cơ chế Bắn
        function shoot(from, isPlayer) {
            const ray = new THREE.Raycaster();
            let dir = isPlayer ? new THREE.Vector3(-Math.sin(yaw), 0, -Math.cos(yaw)) : new THREE.Vector3(Math.random()-0.5, 0, Math.random()-0.5).normalize();
            ray.set(from.position, dir);
            
            const targets = isPlayer ? enemies : [...enemies, player].filter(o => o !== from);
            const hits = ray.intersectObjects(targets);

            if(hits.length > 0) {
                const hit = hits[0].object;
                if(hit === player) {
                    playerHP -= 10;
                    document.getElementById('hp-fill').style.width = playerHP + "%";
                } else {
                    hit.userData.hp -= 50;
                    if(hit.userData.hp <= 0) { scene.remove(hit); enemies.splice(enemies.indexOf(hit), 1); }
                }
            }
        }
        document.getElementById('fire-btn').addEventListener('touchstart', () => shoot(player, true));

        // Game Loop
        function animate() {
            if(playerHP <= 0) { document.getElementById('gameover').style.display = 'flex'; return; }
            if(enemies.length === 0) { document.getElementById('victory').style.display = 'flex'; return; }

            requestAnimationFrame(animate);
            
            // Cập nhật Vòng Bo
            if(zoneRadius > 10) zoneRadius -= 0.1;
            zoneMesh.scale.set(zoneRadius/500, 1, zoneRadius/500);
            document.getElementById('zone-size').innerText = Math.floor(zoneRadius);

            // Check sát thương vòng bo
            const dist = Math.hypot(player.position.x, player.position.z);
            if(dist > zoneRadius) {
                playerHP -= 0.1;
                document.getElementById('hp-fill').style.width = playerHP + "%";
            }

            // Player di chuyển
            player.position.x += (Math.sin(yaw)*moveY + Math.cos(yaw)*moveX)*0.25;
            player.position.z += (Math.cos(yaw)*moveY - Math.sin(yaw)*moveX)*0.25;
            player.rotation.y = yaw;

            // Bot AI & Bo
            enemies.forEach(bot => {
                const bDist = Math.hypot(bot.position.x, bot.position.z);
                if(bDist > zoneRadius) { // Bot chạy vào bo
                    bot.position.x *= 0.99; bot.position.z *= 0.99;
                    bot.userData.hp -= 0.1;
                    if(bot.userData.hp <= 0) { scene.remove(bot); enemies.splice(enemies.indexOf(bot), 1); }
                }
                if(Math.random() < 0.01) shoot(bot, false); // Bot bắn ngẫu nhiên
            });

            document.getElementById('alive-count').innerText = enemies.length + 1;
            camera.position.set(player.position.x + Math.sin(yaw)*8, 5, player.position.z + Math.cos(yaw)*8);
            camera.lookAt(player.position);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
